@page "/product-sales-report"
@using Carnesia.Domain.CMS.Brand;
@using Carnesia.Domain.CMS.Category;
@using Carnesia.Domain.Common.POCO;
@using Carnesia.Domain.MIS.Analytics;
@using Carnesia.Domain.Vendor.Models;
@using Carnesia.Domain.WMS.Store.Models;
@inject IStore _store
@inject IBrand _brand
@inject ICategory _category
@inject IVendor _vendor
@inject IAnalytics _analytics

<MudPaper Class="mx-3 my-16 ma-2">
    <MudContainer Fixed="true">
        <MudGrid>
            <MudItem sm="3">
                <MudDatePicker Label="From Date" @bind-Date="Filter.fromDate" />
            </MudItem>
            <MudItem sm="3">
                <MudDatePicker Label="To Date" @bind-Date="Filter.toDate" />
            </MudItem>
            <MudItem sm="3">
                <MudSelect @bind-Value="Filter.outletId" Label="Outlet" AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem Value="0">All Outlet</MudSelectItem>
                    @foreach (var item in Stores)
                    {
                        <MudSelectItem Value="item.storeId">@item.storeName</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem sm="3">
                <MudSelect @bind-Value="Filter.brandId" Label="Brand" AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem Value="0">All Brand</MudSelectItem>
                    @foreach (var item in Brands)
                    {
                        <MudSelectItem Value="item.brandId">@item.name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem sm="3">
                <MudSelect @bind-Value="Filter.catId" Label="Category" AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem Value="0">All Category</MudSelectItem>
                    @foreach (var item in Categories)
                    {
                        <MudSelectItem Value="item.id">@item.parentCat</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem sm="3">
                <MudSelect @bind-Value="Filter.supplierId" Label="Supplier" AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem Value="0">All Supplier</MudSelectItem>
                    @foreach (var item in Vendors)
                    {
                        <MudSelectItem Value="item.vendorId">@item.name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem sm="3">
                <MudTextField @bind-Value="Filter.sku" Label="SKU" />
            </MudItem>
            <MudItem sm="3">
                <MudTextField @bind-Value="Filter.productCode" Label="Product Code" />
            </MudItem>
            <MudItem sm="3">
                <MudTextField @bind-Value="Filter.productName" Label="Product Name" />
            </MudItem>
            <MudItem sm="3">
                <MudSelect @bind-Value="Filter.costProfitType" Label="Cost Profit Type" AnchorOrigin="Origin.BottomCenter">
                    <MudSelectItem Value="0">All</MudSelectItem>
                    <MudSelectItem Value="1">Revenue</MudSelectItem>
                    <MudSelectItem Value="2">Profit</MudSelectItem>
                </MudSelect>
            </MudItem>
        </MudGrid>

        <div class="d-flex justify-end my-3">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="GetProductsReportByFilter" Disabled="DisableButton">Filter</MudButton>
        </div>

        @if (DisableButton)
        {
            <div class="d-flex justify-center">
                <img style="width: 120px" src="shipping.gif" alt="loading..." />
            </div>
        }

        <MudTable Items="@Elements.cmsRevenue" Dense="@tableCommon.Dense" Hover="@tableCommon.Hover" Bordered="@tableCommon.Bordered" Striped="@tableCommon.Striped" CustomFooter="true">
            <HeaderContent>
                @*<MudTh>Date</MudTh>*@
                @*<MudTh>Sales Date</MudTh>*@
                <MudTh>Child Category</MudTh>
                <MudTh>Brand</MudTh>
                <MudTh>Product Code</MudTh>
                <MudTh>SKU</MudTh>
                <MudTh>Product Name</MudTh>
                <MudTh>Sold QTY.</MudTh>
                <MudTh>Sold Amount</MudTh>
                <MudTh>Total Cost</MudTh>
                <MudTh>Profit</MudTh>
                @*<MudTh>Business Unit</MudTh>
                <MudTh>Transaction</MudTh>
                <MudTh>Item Total</MudTh>
                <MudTh>QTY Total</MudTh>
                <MudTh>Revenue Total</MudTh>
                <MudTh>Shipping Discount</MudTh>
                <MudTh>Discount on Product</MudTh>
                <MudTh>Total Discount</MudTh>
                <MudTh>Revenue After Discount</MudTh>
                <MudTh>Cost</MudTh>
                <MudTh>Cancellation Amount</MudTh>
                <MudTh>Gross Profit</MudTh>*@
            </HeaderContent>
            <RowTemplate>
                @*<MudTd DataLabel="Date">
                        @context.date
                </MudTd>*@
                @*<MudTd DataLabel="Sales Date">@context.salesDate</MudTd>*@
                <MudTd DataLabel="Child Category">@context.salesDate</MudTd>
                <MudTd DataLabel="Brand">@context.salesDate</MudTd>
                <MudTd DataLabel="Product Code">@context.salesDate</MudTd>
                <MudTd DataLabel="SKU">@context.salesDate</MudTd>
                <MudTd DataLabel="Product Name">@context.salesDate</MudTd>
                <MudTd DataLabel="Sold QTY.">@context.salesDate</MudTd>
                <MudTd DataLabel="Sold Amount">@context.salesDate</MudTd>
                <MudTd DataLabel="Total Cost">@context.salesDate</MudTd>
                <MudTd DataLabel="Profit">@context.salesDate</MudTd>
                @*<MudTd DataLabel="Business Unit">@context.buisnessUnit</MudTd>
                <MudTd DataLabel="Transaction">@context.numberOfTransaction</MudTd>
                <MudTd DataLabel="Item Total">@context.itemTotal</MudTd>
                <MudTd DataLabel="QTY Total">@context.qtyTotal</MudTd>
                <MudTd DataLabel="Revenue Total">@context.revenueTotal</MudTd>
                <MudTd DataLabel="Shipping Discount">@context.shippingDiscount</MudTd>
                <MudTd DataLabel="Discount on Product">@context.productDiscount</MudTd>
                <MudTd DataLabel="Total Discount">@context.totalDiscount</MudTd>
                <MudTd DataLabel="Revenue After Discount">@context.afterDiscount</MudTd>
                <MudTd DataLabel="Cost">@context.cost</MudTd>
                <MudTd DataLabel="Cancellation Amount">@context.cancellationAmount</MudTd>
                <MudTd DataLabel="Gross Profit">@context.grosProfit</MudTd>*@
            </RowTemplate>
            <FooterContent>
                <MudTFootRow>
                    <MudTd></MudTd>
                    <MudTd></MudTd>
                    <MudTd Style="font-weight: 600;">Grand Total</MudTd>
                    <MudTd Style="font-weight: 600;">@Elements.cmsRevenue.Sum(x => x.numberOfTransaction)</MudTd>
                    <MudTd Style="font-weight: 600;">@Elements.cmsRevenue.Sum(x => x.itemTotal)</MudTd>
                    <MudTd Style="font-weight: 600;">@Elements.cmsRevenue.Sum(x => x.qtyTotal)</MudTd>
                    <MudTd Style="font-weight: 600;">@Elements.cmsRevenue.Sum(x => x.revenueTotal)</MudTd>
                    <MudTd Style="font-weight: 600;">@Elements.cmsRevenue.Sum(x => x.shippingDiscount)</MudTd>
                    <MudTd Style="font-weight: 600;">@Elements.cmsRevenue.Sum(x => x.productDiscount)</MudTd>
                    <MudTd Style="font-weight: 600;">@Elements.cmsRevenue.Sum(x => x.totalDiscount)</MudTd>
                    <MudTd Style="font-weight: 600;">@Elements.cmsRevenue.Sum(x => x.afterDiscount)</MudTd>
                    <MudTd Style="font-weight: 600;">@Elements.cmsRevenue.Sum(x => x.cost)</MudTd>
                    <MudTd Style="font-weight: 600;">@Elements.cmsRevenue.Sum(x => x.cancellationAmount)</MudTd>
                    <MudTd Style="font-weight: 600;">@Elements.cmsRevenue.Sum(x => x.grosProfit)</MudTd>
                </MudTFootRow>
            </FooterContent>
        </MudTable>

        @*<MudTable Class="mt-5" Items="@Elements.posRevenue" Dense="@tableCommon.Dense" Hover="@tableCommon.Hover" Bordered="@tableCommon.Bordered" Striped="@tableCommon.Striped" CustomFooter="true">
            <HeaderContent>
                <MudTh>Date</MudTh>
                <MudTh>Sales Date</MudTh>
                <MudTh>Business Unit</MudTh>
                <MudTh>Transaction</MudTh>
                <MudTh>Item Total</MudTh>
                <MudTh>QTY Total</MudTh>
                <MudTh>Revenue Total</MudTh>
                <MudTh>Shipping Discount</MudTh>
                <MudTh>Discount on Product</MudTh>
                <MudTh>Total Discount</MudTh>
                <MudTh>Revenue After Discount</MudTh>
                <MudTh>Cost</MudTh>
                <MudTh>Cancellation Amount</MudTh>
                <MudTh>Gross Profit</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Date">
                        @context.date
                </MudTd>
                <MudTd DataLabel="Sales Date">@context.salesDate</MudTd>
                <MudTd DataLabel="Business Unit">@context.buisnessUnit</MudTd>
                <MudTd DataLabel="Transaction">@context.numberOfTransaction</MudTd>
                <MudTd DataLabel="Item Total">@context.itemTotal</MudTd>
                <MudTd DataLabel="QTY Total">@context.qtyTotal</MudTd>
                <MudTd DataLabel="Revenue Total">@context.revenueTotal</MudTd>
                <MudTd DataLabel="Shipping Discount">@context.shippingDiscount</MudTd>
                <MudTd DataLabel="Discount on Product">@context.productDiscount</MudTd>
                <MudTd DataLabel="Total Discount">@context.totalDiscount</MudTd>
                <MudTd DataLabel="Revenue After Discount">@context.afterDiscount</MudTd>
                <MudTd DataLabel="Cost">@context.cost</MudTd>
                <MudTd DataLabel="Cancellation Amount">@context.cancellationAmount</MudTd>
                <MudTd DataLabel="Gross Profit">@context.grosProfit</MudTd>
            </RowTemplate>
            <FooterContent>
                <MudTFootRow>
                    <MudTd></MudTd>
                    <MudTd></MudTd>
                    <MudTd Style="font-weight: 600;">Grand Total</MudTd>
                    <MudTd Style="font-weight: 600;">@Elements.posRevenue.Sum(x => x.numberOfTransaction)</MudTd>
                    <MudTd Style="font-weight: 600;">@Elements.posRevenue.Sum(x => x.itemTotal)</MudTd>
                    <MudTd Style="font-weight: 600;">@Elements.posRevenue.Sum(x => x.qtyTotal)</MudTd>
                    <MudTd Style="font-weight: 600;">@Elements.posRevenue.Sum(x => x.revenueTotal)</MudTd>
                    <MudTd Style="font-weight: 600;">@Elements.posRevenue.Sum(x => x.shippingDiscount)</MudTd>
                    <MudTd Style="font-weight: 600;">@Elements.posRevenue.Sum(x => x.productDiscount)</MudTd>
                    <MudTd Style="font-weight: 600;">@Elements.posRevenue.Sum(x => x.totalDiscount)</MudTd>
                    <MudTd Style="font-weight: 600;">@Elements.posRevenue.Sum(x => x.afterDiscount)</MudTd>
                    <MudTd Style="font-weight: 600;">@Elements.posRevenue.Sum(x => x.cost)</MudTd>
                    <MudTd Style="font-weight: 600;">@Elements.posRevenue.Sum(x => x.cancellationAmount)</MudTd>
                    <MudTd Style="font-weight: 600;">@Elements.posRevenue.Sum(x => x.grosProfit)</MudTd>
                </MudTFootRow>
            </FooterContent>
        </MudTable>*@
    </MudContainer>
</MudPaper>

@code {
    // Page On Load
    protected override async Task OnInitializedAsync()
    {
        await GetStores();
        await GetBrands();
        await GetCategories();
        await GetVendors();
    }

    // Disable Button
    private bool DisableButton { get; set; }

    // Filter
    private AnalyticsFilterDTO Filter = new AnalyticsFilterDTO();

    // Table Elements
    private AnalyticsDTO Elements = new AnalyticsDTO();

    // Table Customaization
    private TableCommon tableCommon = new TableCommon();

    // Get Products
    private async Task GetProductsReportByFilter()
    {
        DisableButton = true;
        try
        {
            Elements = await _analytics.GetProductReportByFilter(Filter);
            DisableButton = false;
        }
        catch (Exception e)
        {
            Console.WriteLine(e.Message);
            DisableButton = false;
        }
    }

    // Stores
    private List<StoreDTO> Stores = new List<StoreDTO>();
    private IEnumerable<VendorDTO> Vendors = new List<VendorDTO>();

    // Get Stores
    private async Task GetStores()
    {
        Stores = await _store.GetStoresAsync();
    }

    // Get Vendors
    private async Task GetVendors()
    {
        Vendors = await _vendor.GetVendorsAsync();

        Console.WriteLine(Vendors.FirstOrDefault().name);
    }

    // Brands
    private List<BrandDTO> Brands = new List<BrandDTO>();

    // Get Brands
    private async Task GetBrands()
    {
        Brands = await _brand.GetBrands();
    }

    // Categories
    private List<ParentCategoryDTO> Categories = new List<ParentCategoryDTO>();

    // Get Categories
    private async Task GetCategories()
    {
        Categories = await _category.GetCategories();
    }
}
