@using Carnesia.Domain.WMS.PO.POCO
@using Carnesia.Shared.CommonComponents
@using Carnesia.Domain.WMS.PO.Models.Awaiting
@inject IDialogService DialogService
@inject IPurchaseOrder _order
@inject ISnackbar snackbar

<MudPaper Class="ma-2 pa-16" Elevation="1">
	<MudContainer Fixed="true">
		<MudGrid Class="justify-center align-baseline">
			<MudItem md="3">
				<MudTextField @bind-Value="POID" Label="PO ID" Variant="Variant.Text" />
			</MudItem>
			<MudItem md="3">
				<div>
					<MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="GetPoByPocode">Filter</MudButton>
				</div>
			</MudItem>
		</MudGrid>

		<MudTable Loading="loadingBar" Class="mt-10" Items="@awaitingPos" Dense="@dense" Hover="@hover" Bordered="@bordered" Striped="@striped">
		@* <MudTable Loading="loadingBar" Class="mt-10" Items="@awaitingPos" Dense="@dense" Hover="@hover" Bordered="@bordered" Striped="@striped" Filter="new Func<AwaitingPo,bool>(FilterCycleCheck)"> *@
			<ToolBarContent>
				<MudSpacer />
				<MudSpacer />
				<MudTextField @bind-Value="SearchTerm" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" />
			</ToolBarContent>
			<HeaderContent>
				<MudTh>Date</MudTh>
				<MudTh>PO ID</MudTh>
				<MudTh>Supplier</MudTh>
				<MudTh>Quantity</MudTh>
				<MudTh>Value</MudTh>
				<MudTh>Action</MudTh>
			</HeaderContent>
			<RowTemplate>
				<MudTd DataLabel="Date">@context.orderDate</MudTd>
				<MudTd DataLabel="PO Id">@context.poCode</MudTd>
				<MudTd DataLabel="Supplier">@context.vendorName</MudTd>
				<MudTd DataLabel="Quantity">@context.poQuantity</MudTd>
				<MudTd DataLabel="Amount">@context.totalAmount</MudTd>
				<MudTd DataLabel="Action">
					<MudIconButton Icon="@Icons.Filled.RemoveRedEye" Color="Color.Warning" aria-label="View Details" OnClick="() => OpenPOListDetailsDialog(context.poCode)" />
					<MudIconButton Icon="@Icons.Filled.Check" Color="Color.Success" aria-label="Approve" OnClick="() => ChangePoStatus(context.poCode)" />
				</MudTd>
			</RowTemplate>
			<PagerContent>
				<MudTablePager />
			</PagerContent>
		</MudTable>

		<div class="d-flex flex-wrap mt-4">
			<MudSwitch @bind-Checked="@hover" Color="Color.Primary">Hover</MudSwitch>
			<MudSwitch @bind-Checked="@dense" Color="Color.Secondary">Dense</MudSwitch>
			<MudSwitch @bind-Checked="@striped" Color="Color.Tertiary">Striped</MudSwitch>
			<MudSwitch @bind-Checked="@bordered" Color="Color.Warning">Bordered</MudSwitch>
			<MudSpacer />
		</div>
	</MudContainer>
</MudPaper>

@code {
	// Filter
	private string POID { get; set; }
	

	// Table Loading BAr
	private bool loadingBar { get; set; } = true;

	// Table Customization
	private bool dense { get; set; }
	private bool hover { get; set; }
	private bool bordered { get; set; }
	private bool striped { get; set; }

	// Search Term
	private string SearchTerm { get; set; }

	// Table Content
	private List<AwaitingPo> awaitingPos = new List<AwaitingPo>();
	protected override async Task OnInitializedAsync()
	{
		awaitingPos = await _order.AwaitingPo();
		loadingBar = false;
	}

	private async Task GetPoByPocode()
	{
		awaitingPos.Clear();
		awaitingPos = await _order.AwaitingPoByPoCode(POID);
	}
	private async Task ChangePoStatus(string poCode)
	{
		var result = await _order.PoApprove(poCode);
		snackbar.Configuration.PositionClass = Defaults.Classes.Position.TopEnd;
		awaitingPos.Clear();
		awaitingPos = await _order.AwaitingPo();
		snackbar.Add(result.Message, Severity.Success);
	}

	// Search Function
	private bool FilterCycleCheck(AwaitingPo item)
	{
        if (item.poCode.ToLower().Contains(SearchTerm.ToLower()) || item.vendorName.ToLower().Contains(SearchTerm.ToLower()))
        {
            return true;
        }
        return false;
    }

	// PO List Details Modal
    private void OpenPOListDetailsDialog(string poCode)
    {
	    var parameters = new DialogParameters { ["poCode"]=poCode };
        var options = new DialogOptions { CloseOnEscapeKey = true, FullWidth=true, CloseButton=true, MaxWidth=MaxWidth.Large };
        DialogService.Show<POListDetails>("", parameters,options);
    }
}